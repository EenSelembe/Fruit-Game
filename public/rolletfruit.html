<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rolet Buah Fullscreen + Sound</title>
<style>
  /* ... gaya CSS kamu tetap sama persis ... */
</style>
</head>
<body>
  <div id="history"></div>
  <div class="main">
    <div id="saldoBox">Saldo: Rp. 0</div>
    <div id="multiplierBox"><div id="multiplierRoll"></div></div>
    <div class="wrap">
      <canvas id="wheel"></canvas>
      <button id="spinBtn">SPIN</button>
    </div>
    <div id="betBox">
      <button id="minusBet">-</button>
      <span id="betValue">Rp. 500</span>
      <button id="plusBet">+</button>
    </div>
    <div id="totalBet">Total Taruhan: Rp. 0</div>
    <div id="betsList">Belum ada taruhan</div>
  </div>
  <div id="overlayWin"><div id="overlayContent"></div></div>

  <!-- ðŸ”Š Audio -->
  <audio id="backsound" loop autoplay>
    <source src="sonds/backsound.mp3" type="audio/mpeg">
  </audio>
  <audio id="soundMultiplier">
    <source src="sonds/roll.mp3" type="audio/mpeg">
  </audio>
  <audio id="soundRolet">
    <source src="sonds/spinnerrolet.mp3" type="audio/mpeg">
  </audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
  authDomain: "fruit-game-5e4a8.firebaseapp.com",
  projectId: "fruit-game-5e4a8",
  storageBucket: "fruit-game-5e4a8.appspot.com",
  messagingSenderId: "936228678997",
  appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
  measurementId: "G-EPTSQQPM4D"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ðŸ”Š Audio
const backsound = document.getElementById("backsound");
const soundMultiplier = document.getElementById("soundMultiplier");
const soundRolet = document.getElementById("soundRolet");

// play helper
function playLoop(audio) {
  audio.loop = true;
  audio.currentTime = 0;
  audio.play().catch(e => console.warn("Play blocked:", e));
}
function stopAudio(audio) {
  audio.pause();
  audio.currentTime = 0;
}
function playOnce(audio) {
  audio.currentTime = 0;
  audio.play().catch(e => console.warn("Play blocked:", e));
}

// auto start backsound
window.addEventListener("DOMContentLoaded", () => {
  backsound.volume = 0.4;
  backsound.play().catch(err => {
    console.log("Autoplay dicegah browser:", err);
    document.body.addEventListener("click", () => backsound.play(), { once: true });
  });
});

// === saldo firebase
let userId=null;
let saldo=0;
const saldoBox=document.getElementById("saldoBox");
function updateSaldo(){ saldoBox.textContent="Saldo: Rp. "+saldo.toLocaleString("id-ID"); }
async function setSaldo(newSaldo){
  if(!userId) return;
  saldo=newSaldo; updateSaldo();
  const userRef=doc(db,"users",userId);
  await updateDoc(userRef,{saldo:saldo});
}
onAuthStateChanged(auth,(user)=>{
  if(user){
    userId=user.uid;
    const userRef=doc(db,"users",userId);
    onSnapshot(userRef,(snap)=>{
      if(snap.exists()){ saldo=snap.data().saldo||0; updateSaldo(); }
    });
  } else { window.location.href="index.html"; }
});

// === logika rolet ===
const canvas=document.getElementById("wheel");
const ctx=canvas.getContext("2d");
const size=340;
canvas.width=size; canvas.height=size;

const spinBtn=document.getElementById("spinBtn");
const historyDiv=document.getElementById("history");
const betsList=document.getElementById("betsList");
const totalBetBox=document.getElementById("totalBet");
const overlayWin=document.getElementById("overlayWin");
const overlayContent=document.getElementById("overlayContent");

function showOverlay(msg){
  overlayContent.textContent=msg;
  overlayWin.classList.add("show");
  setTimeout(()=>overlayWin.classList.remove("show"),3000);
}

// bet
let bet=500;
const betValue=document.getElementById("betValue");
function updateBet(){ betValue.textContent="Rp. "+bet; }
document.getElementById("minusBet").addEventListener("click",()=>{if(bet>500){bet-=500;updateBet();}});
document.getElementById("plusBet").addEventListener("click",()=>{ bet+=500; updateBet(); });

updateBet();

// simbol
const segments=["ðŸŽ","ðŸŒ","ðŸ‡","ðŸ‰","ðŸ’","ðŸ","ðŸ‹","ðŸ¥­","ðŸ¥","ðŸ‘"];
const colors=["#e74c3c","#3498db","#2ecc71","#f1c40f","#9b59b6","#e67e22","#1abc9c","#ff6f61","#16a085","#d35400"];
const N=segments.length;
const R=size/2; const cx=size/2,cy=size/2;

let betsActive={};
function updateBetsList(){
  if(Object.keys(betsActive).length===0){
    betsList.textContent="Belum ada taruhan";
    totalBetBox.textContent="Total Taruhan: Rp. 0";
    return;
  }
  betsList.innerHTML=""; let total=0;
  for(const [sym,val] of Object.entries(betsActive)){
    const div=document.createElement("div");
    div.textContent=sym+" = Rp. "+val;
    betsList.appendChild(div);
    total+=val;
  }
  totalBetBox.textContent="Total Taruhan: Rp. "+total;
}
function getTotalBet(){return Object.values(betsActive).reduce((a,b)=>a+b,0);}

// klik simbol
canvas.addEventListener("click",e=>{
  if(spinning) return;
  if(saldo<bet){alert("Saldo tidak cukup!");return;}
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left; const y=e.clientY-rect.top;
  const dx=x-cx,dy=y-cy;
  let angle=Math.atan2(dy,dx);
  let norm=(angle+2*Math.PI)%(2*Math.PI);
  norm=(norm+Math.PI/2)%(2*Math.PI);
  const index=Math.floor(norm/(2*Math.PI/N));
  const symbol=segments[index];
  setSaldo(saldo-bet);
  betsActive[symbol]=(betsActive[symbol]||0)+bet;
  updateBetsList();
});

// draw wheel
function drawWheel(highlightIndex=null){
  ctx.clearRect(0,0,size,size);
  const startOffset=-Math.PI/2;
  for(let i=0;i<N;i++){
    const a0=startOffset+i*(2*Math.PI/N);
    const a1=a0+(2*Math.PI/N);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,a0,a1); ctx.closePath();
    ctx.fillStyle=colors[i]; ctx.fill();
    const mid=(a0+a1)/2;
    ctx.font="38px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillStyle="#fff";
    ctx.fillText(segments[i], cx+Math.cos(mid)*R*0.72, cy+Math.sin(mid)*R*0.72);
  }
  if(highlightIndex!==null){
    ctx.save();
    const a0=-Math.PI/2+highlightIndex*(2*Math.PI/N);
    const a1=a0+(2*Math.PI/N);
    ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,R,a0,a1); ctx.closePath();
    ctx.lineWidth=14; ctx.strokeStyle="yellow"; ctx.shadowBlur=30; ctx.shadowColor="yellow"; ctx.stroke();
    ctx.restore();
  }
}
drawWheel();

function addHistory(symbol,mult){
  const item=document.createElement("div");
  item.className="hist-item"; item.textContent=symbol+" x"+mult;
  historyDiv.appendChild(item);
  if(historyDiv.children.length>6) historyDiv.removeChild(historyDiv.firstChild);
}

// multiplier
const multiplierChances={5:40,6:20,7:10,8:8,9:6,10:5,30:4,50:4,99:3};
function weightedRandom(chances){
  const total=Object.values(chances).reduce((a,b)=>a+b,0);
  let r=Math.random()*total;
  for(const [value,weight] of Object.entries(chances)){
    if(r<weight) return parseInt(value);
    r-=weight;
  }
}
const multipliers=Object.keys(multiplierChances).map(n=>parseInt(n));
const multiplierRoll=document.getElementById("multiplierRoll");
for(let k=0;k<6;k++){ multipliers.forEach(m=>{const d=document.createElement("div");d.className="mult-item"+(m>=50?" mult-gold":"");d.textContent="x"+m;multiplierRoll.appendChild(d);}); }

function easeOutCubic(t){return 1-Math.pow(1-t,3);}
function spinMultiplier(callback){
  const itemHeight=50;
  const chosen=weightedRandom(multiplierChances);
  const chosenIndex=multipliers.indexOf(chosen);
  const targetIndex=chosenIndex+multipliers.length*4;
  const targetY=-targetIndex*itemHeight;
  multiplierRoll.style.transition="none";
  multiplierRoll.style.transform="translateY(0px)";
  // ðŸ”Š mulai sound multipler (loop)
  playLoop(soundMultiplier);
  requestAnimationFrame(()=>{
    multiplierRoll.style.transition="transform 10s cubic-bezier(0.2,0.8,0.2,1)";
    multiplierRoll.style.transform=`translateY(${targetY}px)`;
  });
  setTimeout(()=>{
    stopAudio(soundMultiplier); // ðŸ”Š stop multipler pas berhenti
    callback(chosen);
  },10000);
}

// spin
let spinning=false;
function spinWheel(multiplier){
  const duration=10000, rotations=20;
  const startIndex=Math.floor(Math.random()*N);
  const finalIndex=Math.floor(Math.random()*N);
  let startTime=null;
  function animate(ts){
    if(!startTime) startTime=ts;
    const progress=Math.min(1,(ts-startTime)/duration);
    const eased=easeOutCubic(progress);
    const stepsTotal=rotations*N+((finalIndex-startIndex+N)%N);
    const currentStep=Math.floor(eased*stepsTotal);
    const index=(startIndex+currentStep)%N;
    drawWheel(index);
    // ðŸ”Š mainkan suara tiap pindah simbol
    playOnce(soundRolet);
    if(progress<1){requestAnimationFrame(animate);}
    else{
      drawWheel(finalIndex);
      const symbol=segments[finalIndex];
      let win=0;
      if(betsActive[symbol]){win=betsActive[symbol]*multiplier; setSaldo(saldo+win);}
      addHistory(symbol,multiplier);
      showOverlay("ðŸŽ‰ Hasil: "+symbol+" x"+multiplier+(win>0? "\nMenang Rp."+win:"\nKalah"));
      betsActive={}; updateBetsList(); spinning=false;
    }
  }
  requestAnimationFrame(animate);
}

function spin(){
  if(spinning) return;
  if(Object.keys(betsActive).length===0){alert("Pasang taruhan dulu!");return;}
  const totalBet=getTotalBet();
  if(saldo<totalBet){alert("Saldo tidak cukup!");return;}
  spinning=true;
  spinMultiplier(mult=>spinWheel(mult));
}
spinBtn.addEventListener("click",spin);
</script>
</body>
</html>
