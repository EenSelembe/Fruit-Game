<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üèÜ Peringkat Saldo</title>
  <style>
    :root {
      --bg: #0c0f14;
      --card: rgba(255, 255, 255, 0.06);
      --card2: rgba(255, 255, 255, 0.08);
      --text: #e6e6e6;
      --muted: #a7b0be;
      --accent: #ffd54f;
      --good: #66ffa6;
      --shadow: 0 8px 16px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      background: #0c0f14;
      font-family: system-ui, Arial, sans-serif;
      color: var(--text);
      display: flex; align-items: center; justify-content: center;
      padding: 10px;
    }
    .wrap {
      width: 100%; max-width: 480px;
      background: var(--card);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }
    .head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      flex-shrink: 0;
    }
    .title { display: flex; align-items: center; gap: 8px; }
    .title h1 { font-size: 16px; margin: 0; }
    .badge { font-size: 11px; color: #111; background: var(--accent); padding: 2px 8px; border-radius: 999px; font-weight: 600; }
    .btn {
      border: none; background: var(--card2); color: var(--text);
      padding: 6px 10px; border-radius: 8px; cursor: pointer; font-size: 12px;
    }
    .me {
      display: flex; justify-content: space-between; align-items: center;
      margin: 10px; padding: 10px; border-radius: 10px;
      background: rgba(255,255,255,.05);
      font-size: 13px;
      flex-shrink: 0;
    }
    .table-container { flex: 1; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead th { text-align: left; padding: 8px; color: var(--muted); font-size: 11px; position: sticky; top: 0; background: #0c0f14; }
    tbody td { padding: 8px; border-top: 1px solid rgba(255,255,255,.05); }
    .rank { width: 36px; text-align: center; font-weight: 700; font-size: 12px; }
    .name { font-weight: 600; display: flex; align-items: center; gap: 6px; }
    .nickname {
      display: inline-block;
      border-radius: 6px;
      padding: 2px 6px;
    }
    .levelTag {
      margin-left: 6px;
      font-size: 11px;
      font-weight: bold;
      color: #ffd54f;
    }
    .name .meTag { margin-left: 4px; font-size: 10px; background: var(--good); color: #111; padding: 1px 5px; border-radius: 999px; }
    .saldoCell { text-align: right; font-weight: 700; white-space: nowrap; }
    .rp { opacity: .8; margin-right: 3px; font-size: 11px; }
    tr.meRow { background: rgba(102, 255, 166, .08); }
    tr.top1 td { background: rgba(255,213,79,.08); }
    tr.top2 td { background: rgba(196,196,196,.08); }
    tr.top3 td { background: rgba(205,127,50,.08); }
    .foot { padding: 8px; font-size: 10px; color: var(--muted); text-align: center; flex-shrink: 0; }

    /* indikator online/offline */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }
    .online { background: #00ff00; }
    .offline { background: #ff0000; }

    @keyframes neonAnim {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="head">
      <div class="title">
        <div>üèÜ</div>
        <h1>Peringkat Saldo</h1>
        <span class="badge" id="totalUsers">‚Ä¶</span>
      </div>
      <div>
        <button class="btn" onclick="history.back()">‚üµ</button>
        <button class="btn" id="refreshBtn">‚ü≥</button>
      </div>
    </header>

    <section class="me">
      <div>
        <div id="myRank">‚Äî</div>
        <div id="myName">‚Äî</div>
      </div>
      <div>
        <span class="rp">Rp</span><span id="mySaldo">0</span>
      </div>
    </section>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th class="rank">#</th>
            <th>Nama</th>
            <th style="text-align:right">Saldo</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="foot" id="updatedAt">‚Äî</div>
  </div>

  <script type="module">
    import { initOnlineStatus } from "./online.js"; 
    initOnlineStatus();

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, doc, getDoc, where, getCountFromServer } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
      authDomain: "fruit-game-5e4a8.firebaseapp.com",
      projectId: "fruit-game-5e4a8",
      storageBucket: "fruit-game-5e4a8.appspot.com",
      messagingSenderId: "936228678997",
      appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
      measurementId: "G-EPTSQQPM4D"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const fmtRp = (n) => Number(n || 0).toLocaleString('id-ID');
    const rowsEl = document.getElementById('rows');
    const myRankEl = document.getElementById('myRank');
    const myNameEl = document.getElementById('myName');
    const mySaldoEl = document.getElementById('mySaldo');
    const totalUsersEl = document.getElementById('totalUsers');
    const updatedAtEl = document.getElementById('updatedAt');

    const setUpdated = () => { 
      updatedAtEl.textContent = 'Diperbarui: ' + new Date().toLocaleString('id-ID'); 
    }

    const usersRef = collection(db, 'users');
    const qTop = query(usersRef, orderBy('saldo', 'desc'));

    function calcLevel(consumed = 0) {
      let level = 0;
      let need = 100000;
      let total = consumed;
      while (total >= need) {
        total -= need;
        level++;
        need = Math.floor(need * 1.5); // tiap level berikutnya makin sulit
      }
      return level;
    }

    onSnapshot(qTop, (snap) => {
      rowsEl.innerHTML = '';
      let rank = 0;
      const now = Date.now();

      snap.forEach((docu) => {
        rank++;
        const u = docu.data();
        const tr = document.createElement('tr');
        const isMe = auth.currentUser && docu.id === auth.currentUser.uid;
        if (isMe) tr.classList.add('meRow');

        // emblem otomatis
        let emblem = '';
        if (rank === 1) emblem = 'ü•á ';
        else if (rank === 2) emblem = 'ü•à ';
        else if (rank === 3) emblem = 'ü•â ';

        // cek lastSeen ‚Üí online kalau < 60 detik
        let statusClass = 'offline';
        if (u.lastSeen && (now - u.lastSeen.toMillis()) < 60000) {
          statusClass = 'online';
        }
        const statusDot = `<span class="status-dot ${statusClass}"></span>`;

        // hitung level dari consumedSaldo
        const level = calcLevel(u.consumedSaldo || 0);

        // background dan border nickname
        let bg = u.bgColor || 'transparent';
        let extraAnim = '';
        if (u.bgGradient) {
          bg = u.bgGradient;
          extraAnim = 'background-size:600% 600%; animation: neonAnim 8s ease infinite;';
        }

        let border = `1px solid ${u.borderColor || '#000'}`;
        let extraBorder = '';
        if (u.borderGradient) {
          const baseBg = u.bgColor || 'transparent';
          border = '3px solid transparent';
          extraBorder = `background-image: linear-gradient(${baseBg}, ${baseBg}), ${u.borderGradient};
                         background-origin: border-box;
                         background-clip: padding-box, border-box;`;
        }

        const style = `
          color:${u.color || '#fff'};
          background:${bg};
          ${extraAnim}
          border:${border};
          border-radius:6px;
          padding:2px 6px;
          ${extraBorder}
        `;

        tr.innerHTML = `
          <td class="rank">${rank}</td>
          <td class="name">
            ${statusDot}
            <span class="nickname" style="${style}">
              ${emblem}${u.name || u.username || '‚Äî'}
              ${isMe ? '<span class="meTag">Saya</span>' : ''}
            </span>
            <span class="levelTag">Lv ${level}</span>
          </td>
          <td class="saldoCell"><span class="rp">Rp</span>${fmtRp(u.saldo)}</td>
        `;
        rowsEl.appendChild(tr);
      });
      setUpdated();
      totalUsers();
    });

    async function totalUsers(){
      try { 
        const res = await getCountFromServer(usersRef); 
        totalUsersEl.textContent = res.data().count + ' user'; 
      } catch(e){ 
        totalUsersEl.textContent = '‚Äî'; 
      }
    }

    async function loadMe(user){
      if(!user){ 
        myRankEl.textContent = 'Login'; 
        myNameEl.textContent = '‚Äî'; 
        mySaldoEl.textContent = '0'; 
        return; 
      }
      const meRef = doc(db, 'users', user.uid);
      const meSnap = await getDoc(meRef);
      if (!meSnap.exists()) return;
      const me = meSnap.data();
      myNameEl.textContent = me.name || me.username || '(Tanpa Nama)';
      mySaldoEl.textContent = fmtRp(me.saldo || 0);
      const qAbove = query(usersRef, where('saldo', '>', me.saldo || 0));
      const above = await getCountFromServer(qAbove);
      myRankEl.textContent = '#' + ((above.data().count || 0) + 1);
    }

    onAuthStateChanged(auth, (user)=>{
      if (!user) {
        window.location.href = "index.html";
      } else {
        loadMe(user);
      }
    });

    document.getElementById('refreshBtn').addEventListener('click', ()=>{
      loadMe(auth.currentUser); 
      setUpdated(); 
    });
  </script>
</body>
</html>
