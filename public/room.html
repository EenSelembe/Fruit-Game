<!DOCTYPE html><html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Room â€“ Voice Chat</title>
  <style>
    body {margin:0; font-family:Arial, sans-serif; background:#0a0e1a; color:#fff;}
    .seats {display:grid; grid-template-columns:repeat(3,1fr); gap:20px; justify-items:center; padding:20px;}
    .seat {width:120px; height:150px; text-align:center; cursor:pointer;}
    .avatar {width:100px; height:100px; border-radius:50%; background:#222; margin:auto; position:relative; border:2px dashed #555; display:flex; align-items:center; justify-content:center;}
    .avatar .mic {position:absolute; right:5px; bottom:5px; font-size:14px; background:#000; padding:2px 5px; border-radius:6px;}
    .avatar .host {position:absolute; left:5px; top:5px; font-size:12px; background:#333; padding:2px 6px; border-radius:6px;}
    .name {margin-top:6px; font-weight:bold;}
    .empty .avatar {opacity:0.6;}
    .nickname{display:inline-block; border-radius:6px; padding:2px 6px}
    @keyframes neonAnim {
      0% { background-position:0% 50%; }
      50% { background-position:100% 50%; }
      100% { background-position:0% 50%; }
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Voice Room</h2>
  <div class="seats" id="seats"></div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
      authDomain: "fruit-game-5e4a8.firebaseapp.com",
      projectId: "fruit-game-5e4a8",
      storageBucket: "fruit-game-5e4a8.appspot.com",
      messagingSenderId: "936228678997",
      appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
      measurementId: "G-EPTSQQPM4D"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const seatsEl = document.getElementById("seats");
    const TOTAL_SEATS = 9;
    let me = { uid:null, name:null };
    let currentRoomId = "demo-room"; // contoh room id tetap

    async function ensureRoomExists(roomId){
      const ref = doc(db, "rooms", roomId);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { createdAt: serverTimestamp() });
      }
    }

    function nicknameHTML(data){
      let bg = data.bgColor || 'transparent';
      let extraAnim = '';
      if(data.bgGradient){ bg = data.bgGradient; extraAnim = 'background-size:600% 600%; animation: neonAnim 8s ease infinite;'; }
      let border = `1px solid ${data.borderColor || '#000'}`;
      let extraBorder = '';
      if(data.borderGradient){
        const baseBg = data.bgColor || 'transparent';
        border = '3px solid transparent';
        extraBorder = `background-image: linear-gradient(${baseBg}, ${baseBg}), ${data.borderGradient};
                       background-origin: border-box; background-clip: padding-box, border-box;`;
      }
      const style = `color:${data.color || '#fff'}; background:${bg}; ${extraAnim} border:${border}; ${extraBorder}`;
      const display = data.name || data.username || 'Anonim';
      return `<span class="nickname" style="${style}">${display}</span>`;
    }

    async function fetchUserProfile(uid){
      const ref = doc(db,'users',uid);
      const snap = await getDoc(ref);
      let prof = { name:'Guest-'+uid.slice(0,5) };
      if(snap.exists()){
        const d = snap.data();
        prof = { name:d.name || d.username || ('Guest-'+uid.slice(0,5)), username:d.username, color:d.color, bgColor:d.bgColor, bgGradient:d.bgGradient, borderColor:d.borderColor, borderGradient:d.borderGradient };
      }
      return prof;
    }

    function seatTemplate(i){
      const isHost = (i===5);
      const seat = document.createElement("div");
      seat.className = "seat empty";
      seat.id = "seat"+i;
      seat.innerHTML = `
        <div class="avatar">
          ${isHost? '<div class="host">ðŸ‘‘</div>':''}
          <div class="mic">ðŸ”‡</div>
        </div>
        <div class="name">Kursi ${i}</div>
      `;
      seat.addEventListener("click", async ()=>{
        await setDoc(doc(db,'rooms',currentRoomId,'seats','seat'+i), {
          occupiedBy: me.uid,
          ts: serverTimestamp()
        });
      });
      return seat;
    }

    async function renderSeats(map={}){
      seatsEl.innerHTML = "";
      for(let i=1;i<=TOTAL_SEATS;i++){
        const data = map['seat'+i];
        const el = seatTemplate(i);
        if(data && data.occupiedBy){
          el.classList.remove('empty');
          const prof = await fetchUserProfile(data.occupiedBy);
          el.querySelector('.name').innerHTML = nicknameHTML(prof);
        }
        seatsEl.appendChild(el);
      }
    }

    function listenSeats(){
      const seatsRef = collection(db,'rooms',currentRoomId,'seats');
      onSnapshot(seatsRef,(snap)=>{
        const all={};
        snap.forEach(d=> all[d.id]=d.data());
        renderSeats(all);
      });
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ await signInAnonymously(auth); return; }
      me.uid = user.uid;
      const prof = await fetchUserProfile(me.uid);
      me.name = prof.name;
      // pastikan room ada
      await ensureRoomExists(currentRoomId);
      // gambar kursi default dulu
      renderSeats();
      // lalu dengarkan update realtime
      listenSeats();
    });
  </script></body>
</html>
