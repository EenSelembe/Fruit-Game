<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Room Demo — Firebase ESM + Fallback + Debug Log</title>
  <!-- (Opsional) Jika pakai CSP ketat, izinkan domain Firebase yang dibutuhkan
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com https://cdn.jsdelivr.net https://unpkg.com; connect-src 'self' https://firestore.googleapis.com https://www.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com; style-src 'self' 'unsafe-inline';"> -->
  <style>
    :root { --bg:#0b1020; --fg:#e6eefc; --muted:#9fb3d9; --accent:#8ad; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:960px;margin:auto;padding:24px}
    h1{font-weight:700;font-size:20px;margin:0 0 16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    code.badge{background:#111a33;border:1px solid #243764;border-radius:10px;padding:6px 10px;color:var(--accent)}
    button{appearance:none;border:1px solid #2b457a;background:#152447;color:var(--fg);border-radius:10px;padding:8px 12px;cursor:pointer}
    button:hover{background:#1b2f5e}
    .card{margin-top:16px;border:1px solid #243764;background:#0f1730;border-radius:12px;padding:12px}
    .label{color:var(--muted)}
    pre#debug{min-height:220px;max-height:360px;overflow:auto;margin:8px 0 0;background:#0b132b;border-radius:8px;padding:10px;border:1px solid #1d2b57;white-space:pre-wrap}
    .small{font-size:12px;color:var(--muted)}
    a { color: #9ecbff; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Room Demo</h1>
    <div class="row">
      <span class="label">Room ID:</span>
      <code id="room-id" class="badge">—</code>
      <button id="btn-new">Buat Room Baru</button>
      <button id="btn-ping">Ping Firestore</button>
    </div>
    <div class="card small">
      <div><strong>Debug Log</strong></div>
      <pre id="debug"></pre>
    </div>
    <p class="small">Tip: Kamu bisa set Room lewat query <code>?room=abc123</code> atau hash <code>#room=abc123</code>.</p>
  </div>  <script type="module">
    // =========== Util & Debug ==========
    const $ = s => document.querySelector(s);
    const debugEl = $('#debug');
    const log = (...args) => {
      const line = args.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join(' ');
      console.log(...args);
      if (debugEl) { debugEl.textContent += line + "\n"; debugEl.scrollTop = debugEl.scrollHeight; }
    };
    window.addEventListener('error', e => log('[window.error]', e.message));
    window.addEventListener('unhandledrejection', e => log('[unhandledrejection]', e.reason?.message || e.reason));

    // Room helpers
    function pickRoomId() {
      const fromQuery = new URLSearchParams(location.search).get('room');
      const fromHash = new URLSearchParams(location.hash.replace(/^#/, '')).get('room');
      return fromQuery || fromHash || randomId(6);
    }
    function randomId(k) {
      const arr = new Uint8Array(k);
      crypto.getRandomValues(arr);
      const alphabet = '23456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
      return Array.from(arr, b => alphabet[b % alphabet.length]).join('');
    }

    function setRoomId(id) {
      $('#room-id').textContent = id;
      const url = new URL(location.href);
      url.searchParams.set('room', id);
      history.replaceState(null, '', url);
    }

    // =========== Resilient ESM Loader ==========
    const cdn = (pkg) => [
      `https://www.gstatic.com/firebasejs/12.2.1/${pkg}.js`,
      `https://cdn.jsdelivr.net/npm/firebase@12.2.1/${pkg}.js`,
      `https://unpkg.com/firebase@12.2.1/${pkg}.js`,
    ];
    const tryImport = async (urls) => {
      let lastErr;
      for (const u of urls) {
        try { const mod = await import(u); log('✓ import', u); return mod; }
        catch (e) { lastErr = e; log('✗ import gagal', u, e.message); }
      }
      throw lastErr;
    };

    // =========== Bootstrap Firebase ==========
    log('Mulai muat Firebase ESM…');
    const appMod = await tryImport(cdn('firebase-app'));
    const { initializeApp, onLog, setLogLevel } = appMod;
    const authMod = await tryImport(cdn('firebase-auth'));
    const { getAuth, signInAnonymously, onAuthStateChanged } = authMod;
    const fsMod = await tryImport(cdn('firebase-firestore'));
    const { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp } = fsMod;

    // Tampilkan log SDK ke Debug Log
    setLogLevel('info');
    onLog(({ level, type, message }) => log(`[SDK ${level}] ${type}: ${message}`));

    // TODO: Ganti dengan konfigurasi project kamu
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
      // (opsional) storageBucket, messagingSenderId, dsb
    };

    // Inisialisasi
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    log('Firebase init OK. Menandatangani anonim…');

    // Sign-in anonim supaya bisa akses rules yang mengizinkan anonymous
    try {
      await signInAnonymously(auth);
    } catch (e) {
      log('AUTH gagal:', e.message);
    }

    let CURRENT_UID = null;
    onAuthStateChanged(auth, (user) => {
      if (!user) { log('AUTH: signed out'); return; }
      CURRENT_UID = user.uid;
      log('AUTH: signed in as', user.uid);
    });

    // =========== Room logic (Firestore) ==========
    let roomId = pickRoomId();
    setRoomId(roomId);
    log('Room aktif =', roomId);

    // Buat dokumen room jika belum ada, lalu subscribe
    const roomRef = doc(db, 'rooms', roomId);
    async function ensureRoomDoc() {
      const snap = await getDoc(roomRef);
      if (!snap.exists()) {
        await setDoc(roomRef, { createdAt: serverTimestamp(), createdBy: CURRENT_UID || null });
        log('Room dibuat di Firestore');
      } else {
        log('Room sudah ada di Firestore');
      }
    }

    await ensureRoomDoc().catch(e => log('Gagal ensure room:', e.message));

    onSnapshot(roomRef, (snap) => {
      const data = snap.data();
      log('onSnapshot:', data ? JSON.stringify(data) : '(null)');
    }, (err) => log('onSnapshot error:', err.message));

    // UI handlers
    $('#btn-new').addEventListener('click', async () => {
      roomId = randomId(6);
      setRoomId(roomId);
      log('Room baru =', roomId);
      await setDoc(doc(db, 'rooms', roomId), {
        createdAt: serverTimestamp(),
        createdBy: CURRENT_UID || null
      });
    });

    $('#btn-ping').addEventListener('click', async () => {
      try {
        await setDoc(roomRef, { lastPingAt: serverTimestamp(), by: CURRENT_UID || null }, { merge: true });
        log('Ping terkirim');
      } catch (e) { log('Ping gagal:', e.message); }
    });
  </script></body>
</html>
