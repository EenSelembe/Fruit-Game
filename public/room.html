<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ruang Suara</title>
  <style>
    :root {
      --bg:#0b0f14; --card:#141a22; --muted:#8892a6; --accent:#4f8cff;
      --ok:#31c48d; --danger:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#e6edf7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji"}
    header{display:flex;gap:.75rem;align-items:center;padding:16px}
    header .badge{font:600 12px/1.6 ui-monospace,Menlo,Consolas;background:#1b2430;color:#bcd; padding:2px 8px;border-radius:8px}
    header h1{font-size:20px;margin:0 8px 0 0}
    #roomName{opacity:.85}
    main{padding:16px;max-width:980px;margin:0 auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px}
    .seat{background:var(--card);border-radius:16px;padding:16px;border:1px solid #1f2835;position:relative}
    .seat h3{margin:0 0 8px;font-size:14px;color:#a9b6cc}
    .who{position:absolute;right:12px;top:12px;font-size:12px;color:#94a3b8;opacity:.9}
    .nick{display:inline-flex;align-items:center;gap:6px;font-weight:700;padding:6px 10px;border-radius:10px;background:#0e1622;border:1px solid #223047}
    .status{margin:10px 0 12px;display:flex;align-items:center;gap:10px;font-size:13px;color:#cbd5e1}
    .status .dot{width:10px;height:10px;border-radius:999px;background:#475569}
    .status .on{background:var(--ok)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer;border:0;border-radius:12px;padding:10px 12px;font-weight:600}
    .btn{background:#1f2a38;color:#dbeafe;border:1px solid #273547}
    .danger{background:#2a1b1b;color:#fecaca;border-color:#3b2323}
    .ok{background:#162722;color:#c7f9e9;border-color:#224235}
    .muted{color:#97a6ba}
    footer{padding:16px;color:#93a4bf;font-size:12px;opacity:.9}
    .meTag{padding:2px 6px;border:1px solid #41506b;border-radius:999px;background:#0f1722;color:#9fb4d8;font-weight:700}
    .toprow{display:flex;justify-content:space-between;align-items:center}
    .sr{position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden}
  </style>
</head>
<body>
  <header>
    <h1>Ruang</h1>
    <span id="roomName" class="badge">main</span>
    <span id="me" class="badge">masukâ€¦</span>
  </header>

  <main>
    <div id="grid" class="grid"></div>
    <footer>
      Tip: ganti room via <code>?room=abc123</code>. Mic butuh HTTPS/izin browser.
    </footer>
  </main>

  <!-- elemen audio remote dibuat dinamis di sini -->
  <div id="audios" class="sr" aria-hidden="true"></div>

  <script type="module">
    /* ---------------- Firebase import ---------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth, signInAnonymously, onAuthStateChanged, updateProfile
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot,
      deleteDoc, query, where, serverTimestamp, updateDoc, arrayUnion
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    /* ---------------- Config kamu ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
      authDomain: "fruit-game-5e4a8.firebaseapp.com",
      projectId: "fruit-game-5e4a8",
      storageBucket: "fruit-game-5e4a8.appspot.com",
      messagingSenderId: "936228678997",
      appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
      measurementId: "G-EPTSQQPM4D"
    };

    /* ---------------- Init ---------------- */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const qs = new URLSearchParams(location.search);
    const ROOM_ID = qs.get("room") || "main";
    document.getElementById("roomName").textContent = ROOM_ID;

    const roomsRef = doc(db, "rooms", ROOM_ID);
    const seatsCol = collection(roomsRef, "seats");
    const signalsCol = collection(roomsRef, "signals"); // dokumen per pasangan peer

    const grid = document.getElementById("grid");
    const audios = document.getElementById("audios");
    const meBadge = document.getElementById("me");

    // state
    let me = null;
    let mySeat = null;
    let localStream = null;
    const pcs = new Map();         // pairKey -> RTCPeerConnection
    const audioEls = new Map();    // uid -> <audio>
    const handledCand = new Map(); // pairKeySide -> Set<string>

    /* --------- UI: render 9 seat card --------- */
    const seatEls = [];
    for (let i=1;i<=9;i++){
      const card = document.createElement("div");
      card.className = "seat";
      card.dataset.seat = String(i);
      card.innerHTML = `
        <div class="toprow">
          <h3>Kursi #${i}</h3>
          <span class="who" id="who-${i}">Ditempati</span>
        </div>
        <div class="nick" id="nick-${i}">Kosong</div>
        <div class="status"><div class="dot" id="dot-${i}"></div><span id="mic-${i}" class="muted">Mic OFF</span></div>
        <div class="row" id="btns-${i}">
          <button class="btn sit">Duduk</button>
          <button class="btn ok mic-on">Nyalakan Mic</button>
          <button class="btn danger leave">Keluar</button>
        </div>
      `;
      grid.appendChild(card);
      seatEls.push(card);
    }

    /* --------- Helpers --------- */
    const pairKey = (a,b)=> a < b ? `${a}_${b}` : `${b}_${a}`;
    const iAmA = (a,b)=> a < b; // apakah UID-ku sisi 'a'?

    function setSeatUI(i, data, isMe){
      const idx = Number(i);
      const nick = document.getElementById(`nick-${idx}`);
      const who  = document.getElementById(`who-${idx}`);
      const dot  = document.getElementById(`dot-${idx}`);
      const micL = document.getElementById(`mic-${idx}`);

      if (!data){
        nick.textContent = "Kosong";
        who.textContent = "Kosong";
        dot.classList.remove("on");
        micL.textContent = "Mic OFF";
        seatEls[idx-1].querySelector(".sit").disabled = false;
        seatEls[idx-1].querySelector(".leave").disabled = true;
        seatEls[idx-1].querySelector(".mic-on").disabled = true;
        return;
      }
      const name = data.name || "GM";
      nick.innerHTML = isMe ? `ðŸ‘‘ <span>${name}</span> <span class="meTag">Anda</span>` : `<span>${name}</span>`;
      who.textContent = isMe ? "Ditempati (Anda)" : "Ditempati";
      if (data.mic){ dot.classList.add("on"); micL.textContent = "Mic ON"; }
      else { dot.classList.remove("on"); micL.textContent = "Mic OFF"; }

      seatEls[idx-1].querySelector(".sit").disabled   = !!data && !isMe;
      seatEls[idx-1].querySelector(".leave").disabled = !isMe;
      seatEls[idx-1].querySelector(".mic-on").disabled = !isMe;
      seatEls[idx-1].querySelector(".mic-on").textContent = data?.mic ? "Matikan Mic" : "Nyalakan Mic";
    }

    async function removeMyOldSeat(){
      if (!me) return;
      const q = query(seatsCol, where("uid","==", me.uid));
      const snap = await getDocs(q);
      for (const d of snap.docs){ await deleteDoc(d.ref); }
      mySeat = null;
    }

    async function takeSeat(seatNo){
      if (!me) return;
      // hapus kursi lama agar tidak dobel
      await removeMyOldSeat();

      const seatRef = doc(seatsCol, String(seatNo));
      await setDoc(seatRef, {
        uid: me.uid,
        name: me.displayName || "GM",
        mic: false,
        ts: serverTimestamp()
      });
      mySeat = seatNo;
    }

    async function leaveSeat(){
      if (!me || !mySeat) return;
      await deleteDoc(doc(seatsCol, String(mySeat)));
      mySeat = null;
      await micToggle(false);
    }

    async function micToggle(turnOn){
      if (!me || !mySeat) return;
      const seatRef = doc(seatsCol, String(mySeat));

      if (turnOn){
        try {
          localStream = await navigator.mediaDevices.getUserMedia({audio:true});
        } catch(e){
          alert("Izin microphone ditolak / tidak tersedia.");
          return;
        }
        await updateDoc(seatRef, { mic: true });

        // hubungkan ke semua pemain lain yang ada
        const all = await getDocs(seatsCol);
        for (const d of all.docs){
          const s = d.data();
          if (!s?.uid || s.uid === me.uid) continue;
          await connectToPeer(s.uid);
        }
      } else {
        // stop mic
        if (localStream){
          localStream.getTracks().forEach(t=>t.stop());
          localStream = null;
        }
        // tutup semua PC
        for (const pc of pcs.values()) try{ pc.close(); } catch{}
        pcs.clear();
        // hapus audio tag
        for (const el of audioEls.values()) try{ el.remove(); } catch{}
        audioEls.clear();

        await updateDoc(seatRef, { mic: false });
      }
    }

    function ensureAudioEl(uid){
      if (audioEls.has(uid)) return audioEls.get(uid);
      const el = document.createElement("audio");
      el.autoplay = true; el.playsInline = true; el.controls = false;
      el.id = `a_${uid}`;
      audios.appendChild(el);
      audioEls.set(uid, el);
      return el;
    }

    async function connectToPeer(otherUid){
      if (!localStream) return;
      const pKey = pairKey(me.uid, otherUid);
      if (pcs.has(pKey)) return; // sudah ada

      const isA = iAmA(me.uid, otherUid);
      const docRef = doc(signalsCol, pKey);
      const pc = new RTCPeerConnection({
        iceServers: [{urls: "stun:stun.l.google.com:19302"}]
      });
      pcs.set(pKey, pc);

      // kirim kandidat ICE ke field sisi masing-masing
      pc.onicecandidate = async (e)=>{
        if (!e.candidate) return;
        const field = isA ? "aCandidates" : "bCandidates";
        try{
          await setDoc(docRef, {[field]: arrayUnion(e.candidate.toJSON())},{merge:true});
        }catch{}
      };

      // terima stream lawan
      pc.ontrack = (ev)=>{
        const audio = ensureAudioEl(otherUid);
        if (!audio.srcObject) audio.srcObject = ev.streams[0];
      };

      // tambahkan track mic-ku
      localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

      // signaling
      const unsub = onSnapshot(docRef, async (snap)=>{
        const data = snap.data() || {};

        // kalau aku sisi B, tunggu aOffer
        if (!isA && data.aOffer && !pc.currentRemoteDescription){
          await pc.setRemoteDescription(new RTCSessionDescription(data.aOffer));
          const ans = await pc.createAnswer();
          await pc.setLocalDescription(ans);
          await setDoc(docRef, { bAnswer: ans, aUid: otherUid, bUid: me.uid }, {merge:true});
        }

        // kalau aku sisi A, tunggu bAnswer
        if (isA && data.bAnswer && !pc.currentRemoteDescription){
          await pc.setRemoteDescription(new RTCSessionDescription(data.bAnswer));
        }

        // kandidat dari lawan
        const otherField = isA ? "bCandidates" : "aCandidates";
        const list = data[otherField] || [];
        const seenKey = pKey + (isA ? "_b":"_a");
        if (!handledCand.has(seenKey)) handledCand.set(seenKey, new Set());
        const seen = handledCand.get(seenKey);
        for (const c of list){
          const sig = JSON.stringify(c);
          if (seen.has(sig)) continue;
          seen.add(sig);
          try { await pc.addIceCandidate(new RTCIceCandidate(c)); } catch {}
        }
      });

      // buat offer bila aku sisi A
      if (isA){
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await setDoc(docRef, {
          aUid: me.uid, bUid: otherUid, aOffer: offer,
          aCandidates: arrayUnion(), bCandidates: arrayUnion(),
          updatedAt: serverTimestamp()
        }, {merge:true});
      }
      // simpan untuk dibersihkan bila perlu
      pc._unsub = unsub;
    }

    /* --------- Event tombol di setiap seat --------- */
    grid.addEventListener("click", async (e)=>{
      const card = e.target.closest(".seat");
      if (!card) return;
      const seatNo = Number(card.dataset.seat);

      if (e.target.classList.contains("sit")){
        await takeSeat(seatNo);
      }
      if (e.target.classList.contains("leave")){
        await leaveSeat();
      }
      if (e.target.classList.contains("mic-on")){
        const btn = e.target;
        const isOn = btn.textContent.includes("Matikan");
        await micToggle(!isOn);
      }
    });

    /* --------- Live sync kursi --------- */
    onSnapshot(seatsCol, (snap)=>{
      const bySeat = {};
      snap.forEach(d=> bySeat[d.id] = d.data());
      for (let i=1;i<=9;i++){
        const data = bySeat[i];
        setSeatUI(i, data, data?.uid === me?.uid);
      }

      // Jika mic-ku ON, koneksikan ke pemain baru yang muncul
      if (localStream){
        for (const id in bySeat){
          const u = bySeat[id]?.uid;
          if (u && u !== me?.uid) connectToPeer(u);
        }
      }

      // Tutup koneksi ke pemain yang sudah tidak ada
      for (const [key, pc] of pcs){
        const [a,b] = key.split("_");
        const other = (a===me?.uid)? b : a;
        const stillThere = Object.values(bySeat).some(s=> s?.uid === other && s?.mic);
        if (!stillThere){
          try { pc._unsub?.(); pc.close(); } catch {}
          pcs.delete(key);
          const el = audioEls.get(other);
          if (el){ try{ el.remove(); }catch{} audioEls.delete(other); }
        }
      }
    });

    /* --------- Auth --------- */
    onAuthStateChanged(auth, async (user)=>{
      if (!user){
        await signInAnonymously(auth);
        return;
      }
      // kasih default displayName biar enak dilihat
      if (!user.displayName){
        const short = "GM";
        try{ await updateProfile(user, {displayName: short}); }catch{}
      }
      me = user;
      meBadge.textContent = `UID: ${user.uid.slice(0,6)}â€¦`;
    });
  </script>
</body>
</html>
