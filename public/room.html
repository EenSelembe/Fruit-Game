<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Room Demo</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --btn: #1e3a8a;
      --btn-hover: #243fa1;
      --pill: #1f2a44;
      --green: #22c55e;
      --red: #ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--text);
    }
    .wrap{max-width: 760px; margin: 32px auto; padding: 0 16px;}
    h1{font-size: 32px; margin: 0 0 16px}
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; background:var(--pill); border:1px solid #243b63; border-radius:999px;
      font-weight:600; letter-spacing:.3px
    }
    .btn{
      background:var(--btn); color:#fff; border:1px solid #1b2f6a; padding:10px 14px;
      border-radius:10px; cursor:pointer; font-weight:600
    }
    .btn:hover{background:var(--btn-hover)}
    .btn.ghost{background:transparent; border-color:#334155; color:var(--text)}
    .panel{
      margin-top:18px; background:var(--panel); border:1px solid #1f2937; border-radius:14px; padding:16px;
    }
    .panel h3{margin:0 0 10px; font-size:16px; color:var(--muted)}
    pre{
      margin:0; padding:12px; max-height:280px; overflow:auto; background:#0b1020; border-radius:10px;
      border:1px solid #1f2a44; font-size:13px; line-height:1.5; white-space:pre-wrap
    }
    .tip{margin-top:14px; color:var(--muted); font-size:14px}
    .dot{
      width:8px;height:8px;border-radius:50%;background:#334155;display:inline-block;margin-right:6px
    }
    .dot.ok{background:var(--green)}
    .dot.err{background:var(--red)}
    a.link{color:#93c5fd;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Room Demo</h1>

    <div class="row" style="margin-bottom:12px">
      <div class="pill">
        <strong>Room ID:</strong>
        <span id="roomId" style="font-variant:tabular-nums">—</span>
      </div>

      <button id="newRoomBtn" class="btn">Buat Room Baru</button>
      <button id="pingBtn" class="btn ghost">Ping Firestore</button>
    </div>

    <div class="panel">
      <h3>Debug Log</h3>
      <pre id="log"></pre>
    </div>

    <p class="tip">
      Tip: Kamu bisa set Room lewat query <code>?room=abc123</code> atau hash <code>#room=abc123</code>.
    </p>
  </div>

  <script type="module">
    // ===== Firebase ESM imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInAnonymously, signOut
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, serverTimestamp,
      collection, addDoc, query, where, getCountFromServer
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // ====== UI helpers
    const $log = document.getElementById("log");
    const log = (...args) => {
      const line = args.map(a => {
        try { return typeof a === "string" ? a : JSON.stringify(a); }
        catch { return String(a); }
      }).join(" ");
      $log.textContent += line + "\n";
      $log.scrollTop = $log.scrollHeight;
    };
    const setOK = (ok) => {
      document.title = ok ? "Room Demo • OK" : "Room Demo • Error";
    };

    // ====== Your Firebase config (punyamu)
    const firebaseConfig = {
      apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
      authDomain: "fruit-game-5e4a8.firebaseapp.com",
      projectId: "fruit-game-5e4a8",
      storageBucket: "fruit-game-5e4a8.appspot.com",
      messagingSenderId: "936228678997",
      appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
      measurementId: "G-EPTSQQPM4D"
    };

    // ====== Initialize
    log("Mulai muat Firebase ESM…");
    log("✓ import https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js");
    log("✓ import https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js");
    log("✓ import https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js");

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    log("Firebase init OK.");

    // ====== Room id helpers
    const $roomId = document.getElementById("roomId");
    const getQS = (k) => new URL(location.href).searchParams.get(k);
    const parseRoomFromUrl = () => {
      const hash = (location.hash || "").replace(/^#/, "");
      // allow "#room=xxx" or just "#xxx"
      if (hash.startsWith("room=")) return hash.split("=")[1];
      if (hash.length > 0) return hash;
      const q = getQS("room");
      return q || null;
    };
    const randomRoom = (len=5) => {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghkmnpqrstuvwxyz23456789";
      let s = "";
      for (let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    };
    const setRoom = (id) => {
      $roomId.textContent = id;
      const url = new URL(location.href);
      url.searchParams.set("room", id);
      history.replaceState(null, "", url.toString());
      location.hash = "room=" + id;
      log("Room aktif =", id);
    };

    // Init room
    setRoom(parseRoomFromUrl() || randomRoom(5));

    // ====== Auth
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        log("AUTH: signed in (anon) uid:", user.uid);
        setOK(true);
      } else {
        try {
          await signInAnonymously(auth);
          // onAuthStateChanged di atas akan terpicu lagi
        } catch (e) {
          log("AUTH gagal:", e.message || e);
          setOK(false);
        }
      }
    });

    // ====== Actions
    document.getElementById("newRoomBtn").addEventListener("click", () => {
      setRoom(randomRoom(5));
    });

    document.getElementById("pingBtn").addEventListener("click", async () => {
      const room = $roomId.textContent.trim();
      try {
        // tulis sebuah dokumen di room saat ini
        const ref = doc(db, "rooms", room);
        await setDoc(ref, { pingAt: serverTimestamp(), ua: navigator.userAgent }, { merge: true });

        // baca kembali untuk memastikan akses
        const snap = await getDoc(ref);
        log("Ping Firestore OK. Data:", snap.exists() ? snap.data() : "(kosong)");
      } catch (e) {
        log("Ping Firestore GAGAL:", e.message || e);
        setOK(false);
      }
    });

    // Optional: expose for console debugging
    window.__app = { app, auth, db };
  </script>
</body>
</html>
