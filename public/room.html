<!DOCTYPE html><html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Room â€“ Voice Chat</title>
  <style>
    body {margin:0; font-family:Arial, sans-serif; background:#0a0e1a; color:#fff;}
    h2 {text-align:center; margin:16px 0 6px}
    .info {text-align:center; font-size:14px; color:#9ab0d6}
    .info code {background:#081132; border:1px dashed #3552a0; padding:2px 6px; border-radius:6px; color:#cfe3ff}
    .info button {margin-left:8px; border:1px solid #2a3562; background:#0c1332; color:#e9f1ff; padding:6px 10px; border-radius:8px; cursor:pointer}.seats {display:grid; grid-template-columns:repeat(3,1fr); gap:20px; justify-items:center; padding:20px;}
.seat {width:120px; height:150px; text-align:center; cursor:pointer;}
.avatar {width:100px; height:100px; border-radius:50%; background:#222; margin:auto; position:relative; border:2px dashed #555; display:flex; align-items:center; justify-content:center;}
.avatar .mic {position:absolute; right:5px; bottom:5px; font-size:14px; background:#000; padding:2px 5px; border-radius:6px;}
.avatar .host {position:absolute; left:5px; top:5px; font-size:12px; background:#333; padding:2px 6px; border-radius:6px;}
.name {margin-top:6px; font-weight:bold;}
.empty .avatar {opacity:0.6;}
.nickname{display:inline-block; border-radius:6px; padding:2px 6px}
@keyframes neonAnim {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

#errBanner{display:none;position:fixed;left:0;right:0;bottom:0;background:#2b0b13;color:#ffd6de;padding:10px 14px;border-top:1px solid #5a1d2e;font-size:14px;z-index:9999}

  </style>
</head>
<body>
  <h2>Voice Room</h2>
  <div class="info">Room ID: <code id="roomId">â€”</code><button id="copyBtn">Copy Link</button></div>
  <div id="status" class="info" style="margin-top:6px"></div>
  <div class="seats" id="seats"></div>
  <div id="errBanner"></div>  <script type="module">
    // ==== Helpers UI ====
    function showStatus(msg){ const el = document.getElementById('status'); if(el) el.textContent = msg; }
    function showError(msg){ const el = document.getElementById('errBanner'); if(!el) return; el.textContent = 'Error: ' + msg; el.style.display='block'; }

    // ==== Firebase ====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
      authDomain: "fruit-game-5e4a8.firebaseapp.com",
      projectId: "fruit-game-5e4a8",
      storageBucket: "fruit-game-5e4a8.appspot.com",
      messagingSenderId: "936228678997",
      appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
      measurementId: "G-EPTSQQPM4D"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ==== DOM Refs ====
    const seatsEl = document.getElementById("seats");
    const roomIdEl = document.getElementById("roomId");
    const copyBtn = document.getElementById("copyBtn");

    // ==== State ====
    const TOTAL_SEATS = 9;
    let me = { uid:null, name:null };
    let currentRoomId = null;
    let mySeat = null; // dibaca dari rooms/{id}.seating

    function getQuery(key){ return new URL(location.href).searchParams.get(key); }

    async function ensureRoomExists(roomId){
      const ref = doc(db, "rooms", roomId);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { createdAt: serverTimestamp() }, { merge:true });
      }
      return ref;
    }

    // Sinkron nama & style dari users/{uid}
    async function fetchUserProfile(uid){
      const ref = doc(db,'users',uid);
      const snap = await getDoc(ref);
      let prof = { name:'Guest-'+uid.slice(0,5) };
      if(snap.exists()){
        const d = snap.data();
        prof = { name:d.name || d.username || ('Guest-'+uid.slice(0,5)), username:d.username, color:d.color, bgColor:d.bgColor, bgGradient:d.bgGradient, borderColor:d.borderColor, borderGradient:d.borderGradient };
      }
      return prof;
    }

    function nicknameHTML(data){
      let bg = data?.bgColor || 'transparent';
      let extraAnim = '';
      if(data?.bgGradient){ bg = data.bgGradient; extraAnim = 'background-size:600% 600%; animation: neonAnim 8s ease infinite;'; }
      let border = `1px solid ${data?.borderColor || '#000'}`;
      let extraBorder = '';
      if(data?.borderGradient){
        const baseBg = data?.bgColor || 'transparent';
        border = '3px solid transparent';
        extraBorder = `background-image: linear-gradient(${baseBg}, ${baseBg}), ${data.borderGradient}; background-origin: border-box; background-clip: padding-box, border-box;`;
      }
      const style = `color:${data?.color || '#fff'}; background:${bg}; ${extraAnim} border:${border}; ${extraBorder}`;
      const display = data?.name || data?.username || 'Anonim';
      return `<span class="nickname" style="${style}">${display}</span>`;
    }

    function seatTemplate(i){
      const isHost = (i===5);
      const seat = document.createElement("div");
      seat.className = "seat empty";
      seat.id = "seat"+i;
      seat.innerHTML = `
        <div class="avatar">
          ${isHost? '<div class="host">ðŸ‘‘</div>':''}
          <div class="mic">ðŸ”‡</div>
        </div>
        <div class="name">Kursi ${i}</div>
      `;
      seat.addEventListener("click", ()=> toggleSeat(i));
      return seat;
    }

    // === Anti-double logic: semua pindah kursi diupdate di satu dokumen rooms/{id}.seating ===
    async function toggleSeat(i){
      if(!currentRoomId || !me.uid){ alert('Memuat... coba lagi'); return; }
      const roomRef = doc(db,'rooms',currentRoomId);
      const partRef = doc(db,'rooms',currentRoomId,'participants',me.uid);
      try{
        await runTransaction(db, async (tx)=>{
          const rsnap = await tx.get(roomRef);
          const data = rsnap.exists()? rsnap.data() : {};
          const seating = data.seating || {}; // {"1": uid, "2": uid, ...}

          // cari kursi saya sekarang
          let cur = null;
          for(let k=1;k<=TOTAL_SEATS;k++){ if(seating[String(k)] === me.uid){ cur = k; break; } }

          const occupied = seating[String(i)] || null;
          if(occupied && occupied !== me.uid){ throw new Error('Kursi sudah ditempati'); }

          if(cur === i){
            // berdiri
            seating[String(i)] = null;
            tx.set(partRef, { uid: me.uid, name: me.name, seat: null, ts: serverTimestamp() }, { merge:true });
          } else {
            if(cur){ seating[String(cur)] = null; }
            seating[String(i)] = me.uid;
            tx.set(partRef, { uid: me.uid, name: me.name, seat: i, ts: serverTimestamp() }, { merge:true });
          }

          tx.set(roomRef, { seating }, { merge:true });
        });
      }catch(err){ showError(err.message); }
    }

    async function renderSeats(seating={}){
      seatsEl.innerHTML = "";
      for(let i=1;i<=TOTAL_SEATS;i++){
        const uid = seating[String(i)] || null;
        const el = seatTemplate(i);
        if(uid){
          el.classList.remove('empty');
          try{ const prof = await fetchUserProfile(uid); el.querySelector('.name').innerHTML = nicknameHTML(prof); el.querySelector('.avatar').style.borderStyle='solid'; }
          catch(err){ /* ignore styling errors */ }
        }
        seatsEl.appendChild(el);
      }
    }

    function listenRoomDoc(){
      const rref = doc(db,'rooms',currentRoomId);
      onSnapshot(rref,(snap)=>{
        const d = snap.data() || {};
        const seating = d.seating || {};
        mySeat = null; for(let k=1;k<=TOTAL_SEATS;k++){ if(seating[String(k)]===me.uid){ mySeat=k; break; } }
        renderSeats(seating);
        showStatus(mySeat? ('Duduk di kursi '+mySeat) : 'Belum duduk');
      },(err)=> showError(err.message));
    }

    // ===== Auth + Room bootstrap =====
    onAuthStateChanged(auth, async (user)=>{
      try{
        if(!user){
          showStatus('Menyambungkan akun...');
          try{ await signInAnonymously(auth); return; }
          catch(e){ showError('Login anonymous gagal. Aktifkan Anonymous di Firebase Auth, atau login di home.html. ('+ (e.code||e.message) +')'); return; }
        }
        me.uid = user.uid; showStatus('Akun: '+me.uid.slice(0,6)+'â€¦');
        const prof = await fetchUserProfile(me.uid); me.name = prof.name;

        const rid = getQuery('id');
        if(rid){ currentRoomId = rid; await ensureRoomExists(currentRoomId); }
        else {
          const rref = doc(collection(db,'rooms')); currentRoomId = rref.id;
          // host auto duduk di kursi 5 pada dokumen room (satu sumber kebenaran)
          await setDoc(rref, { createdAt: serverTimestamp(), host: me.uid, hostName: me.name, seating: { '5': me.uid } });
          await setDoc(doc(db,'rooms',currentRoomId,'participants',me.uid), { uid: me.uid, name: me.name, seat: 5, ts: serverTimestamp() }, { merge:true });
        }

        roomIdEl.textContent = currentRoomId;
        copyBtn.onclick = async ()=>{
          const url = location.origin + location.pathname + '?id=' + currentRoomId;
          try{ await navigator.clipboard.writeText(url); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Link',1200);}catch(_){ alert(url); }
        };

        renderSeats({});
        listenRoomDoc();
        showStatus('Siap. Klik kursi untuk duduk/pindah. Klik kursi sendiri untuk berdiri.');
      }catch(err){ showError(err.message); }
    });

    window.addEventListener('error', (e)=> showError(e.error?.message || e.message));
    window.addEventListener('unhandledrejection', (e)=> showError(e.reason?.message || String(e.reason)) );
  </script></body>
</html>
