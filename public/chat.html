<!-- chat.html -->
<style>
  /* Ikon chat mengambang */
  #chatIcon {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 50px; height: 50px;
    border-radius: 50%;
    background: gold;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    cursor: pointer;
    z-index: 9999;
    box-shadow: 0 4px 8px rgba(0,0,0,.4);
    user-select: none;
  }

  /* Panel chat */
  #chatPanel {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    height: 50%;
    background: rgba(0,0,0,0.85);
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    display: none;
    flex-direction: column;
    z-index: 9998;
  }

  #chatHeader {
    padding: 10px;
    font-weight: bold;
    text-align: center;
    color: #fff;
    border-bottom: 1px solid rgba(255,255,255,.2);
    display: flex; justify-content: space-between; align-items: center;
  }

  #chatMessages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    font-size: 14px;
    color: #fff;
  }

  #chatInputBox {
    display: flex;
    padding: 10px;
    border-top: 1px solid rgba(255,255,255,.2);
    background: rgba(0,0,0,.7);
  }

  #chatInputBox input {
    flex: 1;
    padding: 8px;
    border-radius: 6px;
    border: none;
  }

  #chatInputBox button {
    margin-left: 8px;
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    background: gold;
    cursor: pointer;
    font-weight: bold;
  }

  .msg { margin: 4px 0; }
  .admin { color: #00ff66; font-weight: bold; } /* hijau stabilo untuk admin */
</style>

<div id="chatIcon">üí¨</div>

<div id="chatPanel">
  <div id="chatHeader">
    <span>üåê Chat Global</span>
    <button id="chatCloseBtn">‚úñ</button>
  </div>
  <div id="chatMessages"></div>
  <div id="chatInputBox">
    <input id="chatInput" type="text" placeholder="Ketik pesan..." />
    <button id="chatSendBtn">Kirim</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
    authDomain: "fruit-game-5e4a8.firebaseapp.com",
    projectId: "fruit-game-5e4a8",
    storageBucket: "fruit-game-5e4a8.appspot.com",
    messagingSenderId: "936228678997",
    appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const chatIcon = document.getElementById("chatIcon");
  const chatPanel = document.getElementById("chatPanel");
  const chatCloseBtn = document.getElementById("chatCloseBtn");
  const chatMessages = document.getElementById("chatMessages");
  const chatInput = document.getElementById("chatInput");
  const chatSendBtn = document.getElementById("chatSendBtn");

  // üëâ Toggle panel
  chatIcon.addEventListener("click", () => {
    chatPanel.style.display = "flex";
    chatIcon.style.display = "none";
  });
  chatCloseBtn.addEventListener("click", () => {
    chatPanel.style.display = "none";
    chatIcon.style.display = "flex";
  });

  // üëâ Geser chat icon
  let isDragging = false, offsetX, offsetY;
  chatIcon.addEventListener("mousedown", (e) => {
    isDragging = true;
    offsetX = e.clientX - chatIcon.getBoundingClientRect().left;
    offsetY = e.clientY - chatIcon.getBoundingClientRect().top;
  });
  document.addEventListener("mousemove", (e) => {
    if (isDragging) {
      chatIcon.style.left = (e.clientX - offsetX) + "px";
      chatIcon.style.top = (e.clientY - offsetY) + "px";
      chatIcon.style.bottom = "auto"; // supaya bebas
      chatIcon.style.right = "auto";
    }
  });
  document.addEventListener("mouseup", () => isDragging = false);

  // üëâ Kirim pesan
  async function sendMessage(uid, name, msg) {
    if (!msg.trim()) return;
    await addDoc(collection(db, "globalChat"), {
      uid, name, msg,
      time: serverTimestamp()
    });
    chatInput.value = "";
  }

  chatSendBtn.addEventListener("click", () => {
    if (!auth.currentUser) return;
    sendMessage(auth.currentUser.uid, auth.currentUser.email, chatInput.value);
  });
  chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") chatSendBtn.click();
  });

  // üëâ Tampilkan pesan terakhir (max 50)
  const q = query(collection(db, "globalChat"), orderBy("time", "desc"), limit(50));
  onSnapshot(q, (snap) => {
    chatMessages.innerHTML = "";
    snap.forEach((doc) => {
      const d = doc.data();
      const div = document.createElement("div");
      div.className = "msg";
      if (d.uid === "AxB4G2xwhiXdJnyDrzn82Xanc4x2") {
        div.innerHTML = `<span class="admin">[ADMIN]</span> ${d.name}: ${d.msg}`;
      } else {
        div.textContent = `${d.name}: ${d.msg}`;
      }
      chatMessages.prepend(div);
    });
  });
</script>
