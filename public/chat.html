<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <style>
    /* === ICON CHAT MENGAMBANG === */
    #chatIcon {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 55px;
      height: 55px;
      background: crimson;
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: grab;
      z-index: 9999;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
      user-select: none;
    }

    /* === BOX CHAT === */
    #chatBox {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60%;
      background: rgba(0,0,0,0.85);
      color: white;
      display: none;
      flex-direction: column;
      z-index: 9998;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    #chatHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      font-weight: bold;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-size: 14px;
    }
    #chatInputArea {
      display: flex;
      padding: 8px;
      background: rgba(255,255,255,0.1);
    }
    #chatInput {
      flex: 1;
      padding: 6px;
      border-radius: 6px;
      border: none;
      outline: none;
    }
    #chatSend {
      margin-left: 8px;
      padding: 6px 12px;
      background: gold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    /* Pesan admin */
    .adminMsg {
      color: #00ff66;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Icon chat mengambang -->
  <div id="chatIcon">üí¨</div>

  <!-- Box chat -->
  <div id="chatBox">
    <div id="chatHeader">
      <span>üåê Chat Global</span>
      <button id="chatClose">‚úñ</button>
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputArea">
      <input type="text" id="chatInput" placeholder="Ketik pesan..." />
      <button id="chatSend">Kirim</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // === CONFIG FIREBASE ===
    const firebaseConfig = {
      apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
      authDomain: "fruit-game-5e4a8.firebaseapp.com",
      projectId: "fruit-game-5e4a8",
      storageBucket: "fruit-game-5e4a8.appspot.com",
      messagingSenderId: "936228678997",
      appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
      measurementId: "G-EPTSQQPM4D"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const chatIcon = document.getElementById("chatIcon");
    const chatBox = document.getElementById("chatBox");
    const chatClose = document.getElementById("chatClose");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    let currentUser = null;

    // === Auth listener ===
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
    });

    // === Toggle chat ===
    chatIcon.addEventListener("click", () => {
      chatBox.style.display = "flex";
      chatIcon.style.display = "none";
    });
    chatClose.addEventListener("click", () => {
      chatBox.style.display = "none";
      chatIcon.style.display = "flex";
    });

    // === Geser icon ===
    let offsetX, offsetY, isDragging = false;
    chatIcon.addEventListener("mousedown", startDrag);
    chatIcon.addEventListener("touchstart", startDrag);
    function startDrag(e) {
      isDragging = true;
      offsetX = (e.touches ? e.touches[0].clientX : e.clientX) - chatIcon.offsetLeft;
      offsetY = (e.touches ? e.touches[0].clientY : e.clientY) - chatIcon.offsetTop;
      document.addEventListener("mousemove", drag);
      document.addEventListener("touchmove", drag);
      document.addEventListener("mouseup", stopDrag);
      document.addEventListener("touchend", stopDrag);
    }
    function drag(e) {
      if (!isDragging) return;
      e.preventDefault();
      let x = (e.touches ? e.touches[0].clientX : e.clientX) - offsetX;
      let y = (e.touches ? e.touches[0].clientY : e.clientY) - offsetY;
      chatIcon.style.left = x + "px";
      chatIcon.style.top = y + "px";
      chatIcon.style.right = "auto";
      chatIcon.style.bottom = "auto";
      chatIcon.style.position = "fixed";
    }
    function stopDrag() {
      isDragging = false;
      document.removeEventListener("mousemove", drag);
      document.removeEventListener("touchmove", drag);
    }

    // === Load pesan (max 50 terakhir) ===
    const q = query(collection(db, "globalChat"), orderBy("time", "desc"), limit(50));
    onSnapshot(q, (snap) => {
      chatMessages.innerHTML = "";
      let messages = [];
      snap.forEach(doc => messages.push({ id: doc.id, ...doc.data() }));
      messages.reverse().forEach(m => {
        const div = document.createElement("div");
        const isAdmin = m.uid === "AxB4G2xwhiXdJnyDrzn82Xanc4x2"; // UID admin
        div.innerHTML = `<span class="${isAdmin ? 'adminMsg' : ''}">
          ${m.name || "Anonim"}: ${m.text}
        </span>`;
        chatMessages.appendChild(div);
      });
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // === Kirim pesan ===
    async function sendMessage() {
      if (!currentUser || !chatInput.value.trim()) return;
      await addDoc(collection(db, "globalChat"), {
        uid: currentUser.uid,
        name: currentUser.displayName || currentUser.email || "Anonim",
        text: chatInput.value.trim(),
        time: serverTimestamp()
      });
      chatInput.value = "";
    }
    chatSend.addEventListener("click", sendMessage);
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>
