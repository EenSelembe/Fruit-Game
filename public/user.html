<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel - Daftar User</title>
  <style>
    :root{ --bg:#111; --panel:#181818; --text:#fff; --muted:#bbb; --line:#444; --accent:#4caf50; --warn:#ffc107; --err:#ff5252; }
    *{ box-sizing:border-box }
    body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); margin:0; padding:16px }
    h2 { margin: 6px 0 10px; }
    #topbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px }
    .pill{ background:#222; border:1px solid var(--line); padding:6px 10px; border-radius:999px; font-size:13px; color:var(--muted) }
    .btn { padding: 6px 10px; cursor: pointer; border: 1px solid var(--line); border-radius: 8px; background:#222; color:#fff }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn-update{ background: var(--accent); border-color: #2e7d32; color:#fff; font-weight:700 }
    .btn-refresh{ background:#2d5eff; border-color:#2847a3 }
    .ok{ color:#75fb79 } .warn{ color:var(--warn) } .err{ color:var(--err) }

    table { width: 100%; border-collapse: collapse; margin-top: 14px; background:var(--panel); border:1px solid var(--line) }
    th, td { border: 1px solid var(--line); padding: 8px; text-align: center; font-size:14px }
    th { background: #222; position:sticky; top:0; z-index:1 }
    td code { font-size:12px }
    input, select { background:#1b1b1b; border:1px solid var(--line); color:#fff; padding:6px; border-radius:6px }
    input[type="number"]{ width:100px }
    input[type="text"]{ width:160px }
    input[type="color"]{ width:46px; height:32px; padding:0 }
    .table-wrap{ overflow:auto; max-height: 65vh; border:1px solid var(--line); border-radius:10px }

    #status { margin: 10px 0 6px; font-size:14px }
    #log { margin-top:12px; background:#0e0e0e; border:1px solid var(--line); color:#ddd; padding:10px;
           border-radius:10px; max-height:160px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; white-space:pre-wrap }
    @media (max-width:680px){
      td:nth-child(1){ max-width:150px; overflow:hidden; text-overflow:ellipsis }
      input[type="text"]{ width:140px }
      .table-wrap{ max-height: 55vh; }
    }
  </style>
</head>
<body>
  <h2>üìã Admin Panel ‚Äî Daftar User</h2>

  <div id="topbar">
    <span class="pill">UID Admin: <code id="myuid">-</code></span>
    <span class="pill">Email: <span id="myemail">-</span></span>
    <button id="btnRefresh" class="btn btn-refresh">Refresh Token & Reload</button>
  </div>

  <div id="status">üîí Harus login sebagai admin dulu‚Ä¶</div>

  <div class="table-wrap">
    <table id="usersTable" style="display:none;">
      <thead>
        <tr>
          <th>UID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Saldo</th>
          <th>Warna Teks</th>
          <th>Warna Border</th>
          <th>BG Color</th>
          <th>Border Gradient</th>
          <th>BG Gradient (Preset)</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <pre id="log"></pre>

  <!-- ===== SCRIPT (module) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore, collection, getDocs, doc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // === CONFIG ===
    const firebaseConfig = {
      apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
      authDomain: "fruit-game-5e4a8.firebaseapp.com",
      projectId: "fruit-game-5e4a8",
      storageBucket: "fruit-game-5e4a8.appspot.com",
      messagingSenderId: "936228678997",
      appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
      measurementId: "G-EPTSQQPM4D"
    };
    const ADMIN_UID = "AxB4G2xwhiXdJnyDrzn82Xanc4x2";

    // === INIT ===
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    setPersistence(auth, browserLocalPersistence).catch(()=>{});

    // UI refs
    const elStatus = document.getElementById("status");
    const elMeUid = document.getElementById("myuid");
    const elMeEmail = document.getElementById("myemail");
    const elTable = document.getElementById("usersTable");
    const elLog = document.getElementById("log");
    const btnRefresh = document.getElementById("btnRefresh");

    function log(msg){ elLog.textContent += `[INFO] ${msg}\n`; elLog.scrollTop = elLog.scrollHeight; }
    function logErr(e){ elLog.textContent += `[ERR ] ${(e && e.code)||''} ${(e && e.message)||e}\n`; elLog.scrollTop = elLog.scrollHeight; }

    // Preset gradient list
    const presets = {
      "": "",
      "üåà Rainbow": "linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet)",
      "üíú Pink-Purple": "linear-gradient(270deg, #ff00ff, #8000ff, #ff00ff)",
      "üíô Cyan-Blue": "linear-gradient(270deg, #00ffff, #0066ff, #00ffff)",
      "üî• Gold-Red": "linear-gradient(270deg, gold, orange, red, gold)",
      "üåå Galaxy": "linear-gradient(270deg, #00f, #8000ff, #ff00ff, #00f)",
      "üíö Green Neon": "linear-gradient(270deg, #00ff00, #00cc66, #00ff00)"
    };

    async function loadUsers() {
      try{
        if (!auth.currentUser) return;
        // memastikan token admin (agar rules membaca claim terbaru)
        await auth.currentUser.getIdToken(true);

        const qs = await getDocs(collection(db, "users"));
        const tbody = document.querySelector("#usersTable tbody");
        tbody.innerHTML = "";

        qs.forEach((docSnap)=>{
          const data = docSnap.data() || {};
          // build options
          let options = "";
          for (const [label, value] of Object.entries(presets)) {
            const sel = (data.bgGradient || "") === value ? "selected" : "";
            options += `<option value="${value}" ${sel}>${label}</option>`;
          }

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td style="font-size:12px"><code>${docSnap.id}</code></td>
            <td><input type="text" id="username-${docSnap.id}" value="${(data.username||'').replace(/"/g,'&quot;')}" style="width:120px; color:${data.color || '#fff'};"></td>
            <td>${data.email || ''}</td>
            <td><input type="number" id="saldo-${docSnap.id}" value="${Number(data.saldo||0)}" style="width:90px;"></td>
            <td><input type="color" id="color-${docSnap.id}" value="${data.color || '#ffffff'}"></td>
            <td><input type="color" id="border-${docSnap.id}" value="${data.borderColor || '#000000'}"></td>
            <td><input type="text" id="bg-${docSnap.id}" value="${data.bgColor || '#000000'}"></td>
            <td><input type="text" id="bordergrad-${docSnap.id}" value="${data.borderGradient || ''}" placeholder="linear-gradient(...)"></td>
            <td><select id="bggrad-${docSnap.id}" style="width:170px;">${options}</select></td>
            <td><button class="btn btn-update" data-uid="${docSnap.id}">Update</button></td>
          `;
          tbody.appendChild(tr);
        });

        elStatus.innerHTML = "‚úÖ <span class='ok'>Login admin</span> ‚Ä¢ boleh mengubah data user";
        elTable.style.display = "table";
        log(`Loaded ${qs.size} users.`);
      }catch(e){
        elStatus.innerHTML = "‚ö†Ô∏è <span class='warn'>Gagal load users</span>";
        logErr(e);
        alert("Gagal memuat users: " + (e.message || e.code));
      }
    }

    async function updateUser(uid){
      try{
        if (!auth.currentUser) throw new Error("Belum login");
        await auth.currentUser.getIdToken(true);

        const newSaldo = Number(document.getElementById("saldo-" + uid).value);
        const newColor = document.getElementById("color-" + uid).value;
        const newBorder = document.getElementById("border-" + uid).value;
        const newBg = document.getElementById("bg-" + uid).value;
        const newBorderGrad = document.getElementById("bordergrad-" + uid).value;
        const newBgGrad = document.getElementById("bggrad-" + uid).value;
        const newUsername = document.getElementById("username-" + uid).value;

        const ref = doc(db, "users", uid);
        await setDoc(ref, {
          saldo: isFinite(newSaldo) ? newSaldo : 0,
          color: newColor || null,
          borderColor: newBorder || null,
          bgColor: newBg || null,
          borderGradient: newBorderGrad || null,
          bgGradient: newBgGrad || null,
          username: newUsername || null
        }, { merge: true });

        log(`Updated ${uid}`);
        alert("‚úÖ Berhasil update: " + uid);
        await loadUsers();
      }catch(e){
        logErr(e);
        alert("Gagal update: " + (e.code || "") + " " + (e.message || e));
      }
    }

    // === Event delegation untuk tombol Update (tanpa inline onclick) ===
    document.addEventListener("click", async (ev)=>{
      const btn = ev.target.closest(".btn-update");
      if (!btn) return;
      const uid = btn.dataset.uid;
      btn.disabled = true;
      const prev = btn.textContent;
      btn.textContent = "Updating...";
      try{
        await updateUser(uid);
      } finally {
        btn.disabled = false;
        btn.textContent = prev;
      }
    });

    // Tombol refresh token + reload daftar
    btnRefresh.addEventListener("click", async ()=>{
      try {
        if (auth.currentUser) {
          await auth.currentUser.getIdToken(true);
          log("Token refreshed.");
          await loadUsers();
        } else {
          log("Belum login.");
        }
      } catch(e){ logErr(e); alert("Gagal refresh token: "+(e.message||e.code)); }
    });

    // Auth flow
    onAuthStateChanged(auth, async (user)=>{
      try{
        if (user) {
          elMeUid.textContent = user.uid;
          elMeEmail.textContent = user.email || "(no email)";
          await user.getIdToken(true);
          const idTokRes = await user.getIdTokenResult();
          const claimAdmin = idTokRes.claims?.isAdmin === true || idTokRes.claims?.isAdmin === "true";
          if (user.uid === ADMIN_UID || claimAdmin) {
            elStatus.innerHTML = "‚úÖ <span class='ok'>Login admin terdeteksi</span>";
            await loadUsers();
          } else {
            elStatus.innerHTML = "üö´ <span class='err'>Kamu bukan admin</span> ‚Ä¢ UID: <code>"+user.uid+"</code>";
            elTable.style.display = "none";
            log("Bukan admin: "+user.uid);
          }
        } else {
          const email = prompt("Masukkan email admin:");
          const password = prompt("Masukkan password admin:");
          if (email && password) {
            try { await signInWithEmailAndPassword(auth, email, password); }
            catch(e){ logErr(e); alert("Login gagal: " + (e.message || e.code)); }
          } else {
            log("Login dibatalkan.");
          }
        }
      }catch(e){ logErr(e); }
    });
  </script>
</body>
</html>
