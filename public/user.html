<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Daftar User</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; margin:0; padding:16px;}
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #444; padding: 8px; text-align: center; }
    th { background: #222; position:sticky; top:0; z-index:2; }
    .btn { padding: 6px 10px; cursor: pointer; border: none; border-radius: 6px; }
    .btn-update { background: #4caf50; color: white; }
    .btn-signout { background:#e53935; color:#fff; }
    .btn-login { background:#1e88e5; color:#fff; }
    input, select { background:#1a1a1a; border:1px solid #444; color:#fff; padding:4px 6px; border-radius:4px; }
    #status { margin:10px 0; opacity:.9 }
    .note { font-size:13px; opacity:.8; margin-top:6px }
    .wrap { max-width: 1200px; margin: 0 auto; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h2>üìã Daftar User</h2>
    <div>
      <button id="loginBtn" class="btn btn-login" style="display:none;">Login Admin</button>
      <button id="logoutBtn" class="btn btn-signout" style="display:none;">Sign out</button>
    </div>
  </header>

  <div id="status">üîí Harus login sebagai admin dulu...</div>
  <div class="note">Admin dikenali jika <code>UID === ADMIN_UID</code> <b>atau</b> token punya claim <code>isAdmin: true</code>.</div>

  <table id="usersTable" style="display:none;">
    <thead>
      <tr>
        <th>UID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Saldo</th>
        <th>Warna Teks</th>
        <th>Warna Border</th>
        <th>BG Color</th>
        <th>Border Gradient</th>
        <th>BG Gradient (Preset)</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } 
    from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, updateDoc } 
    from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
    authDomain: "fruit-game-5e4a8.firebaseapp.com",
    projectId: "fruit-game-5e4a8",
    storageBucket: "fruit-game-5e4a8.appspot.com",
    messagingSenderId: "936228678997",
    appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
    measurementId: "G-EPTSQQPM4D"
  };

  const ADMIN_UID = "AxB4G2xwhiXdJnyDrzn82Xanc4x2"; // pastikan sama dengan di Firestore rules

  // Preset gradient list
  const presets = {
    "": "",
    "üåà Rainbow": "linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet)",
    "üíú Pink-Purple": "linear-gradient(270deg, #ff00ff, #8000ff, #ff00ff)",
    "üíô Cyan-Blue": "linear-gradient(270deg, #00ffff, #0066ff, #00ffff)",
    "üî• Gold-Red": "linear-gradient(270deg, gold, orange, red, gold)",
    "üåå Galaxy": "linear-gradient(270deg, #00f, #8000ff, #ff00ff, #00f)",
    "üíö Green Neon": "linear-gradient(270deg, #00ff00, #00cc66, #00ff00)"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl = document.getElementById("status");
  const usersTable = document.getElementById("usersTable");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  loginBtn.addEventListener("click", async ()=>{
    const email = prompt("Masukkan email admin:");
    const password = prompt("Masukkan password admin:");
    if (!email || !password) return;
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (e) {
      alert("Login gagal: " + (e?.message || e));
    }
  });

  logoutBtn.addEventListener("click", async ()=>{
    try { await signOut(auth); } catch(e) {}
  });

  function isAdminLocal(user, token) {
    const byUid = user?.uid === ADMIN_UID;
    const byClaim = !!token?.claims?.isAdmin;
    return byUid || byClaim;
  }

  async function loadUsers() {
    const tbody = usersTable.querySelector("tbody");
    tbody.innerHTML = "";
    const snap = await getDocs(collection(db, "users"));

    snap.forEach((docSnap) => {
      const data = docSnap.data() || {};
      const tr = document.createElement("tr");

      // Dropdown preset
      let options = "";
      for (const [label, value] of Object.entries(presets)) {
        const selected = (data.bgGradient || "") === value ? "selected" : "";
        options += `<option value="${value}" ${selected}>${label}</option>`;
      }

      tr.innerHTML = `
        <td style="font-size:12px;opacity:.85">${docSnap.id}</td>
        <td><input type="text" id="username-${docSnap.id}" value="${data.username || data.name || ''}" style="width:140px; color:${data.color || '#fff'};"></td>
        <td style="font-size:12px;opacity:.9">${data.email || ''}</td>
        <td><input type="number" id="saldo-${docSnap.id}" value="${Number(data.saldo||0)}" style="width:90px;"></td>
        <td><input type="color" id="color-${docSnap.id}" value="${data.color || '#ffffff'}"></td>
        <td><input type="color" id="border-${docSnap.id}" value="${data.borderColor || '#000000'}"></td>
        <td><input type="text" id="bg-${docSnap.id}" value="${data.bgColor || ''}" placeholder="#000000 / kosong" style="width:120px;"></td>
        <td><input type="text" id="bordergrad-${docSnap.id}" value="${data.borderGradient || ''}" placeholder="linear-gradient(...)" style="width:160px;"></td>
        <td><select id="bggrad-${docSnap.id}" style="width:170px;">${options}</select></td>
        <td><button class="btn btn-update" id="btn-${docSnap.id}">Update</button></td>
      `;
      tbody.appendChild(tr);

      // Attach handler
      const btn = tr.querySelector(`#btn-${docSnap.id}`);
      btn.addEventListener("click", () => updateUser(docSnap.id));
    });

    usersTable.style.display = "table";
  }

  async function updateUser(uid) {
    const newSaldo = Number(document.getElementById("saldo-" + uid).value);
    const newColor = document.getElementById("color-" + uid).value || null;
    const newBorder = document.getElementById("border-" + uid).value || null;
    const newBg = document.getElementById("bg-" + uid).value || "";
    const newBorderGrad = document.getElementById("bordergrad-" + uid).value || "";
    const newBgGrad = document.getElementById("bggrad-" + uid).value || "";
    const newUsername = document.getElementById("username-" + uid).value || "";

    const userDocRef = doc(db, "users", uid);

    try {
      await updateDoc(userDocRef, { 
        saldo: isFinite(newSaldo) ? newSaldo : 0,
        color: newColor,
        borderColor: newBorder,
        bgColor: newBg || null,
        borderGradient: newBorderGrad || null,
        bgGradient: newBgGrad || null,
        username: newUsername
      });
      alert("‚úÖ User " + uid + " berhasil diupdate!");
    } catch (e) {
      console.error(e);
      alert("‚ùå Gagal update user " + uid + ":\n" + (e?.message || e));
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      statusEl.textContent = "üîí Harus login sebagai admin dulu...";
      usersTable.style.display = "none";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      return;
    }
    loginBtn.style.display = "none";
    logoutBtn.style.display = "inline-block";

    try {
      // refresh token supaya custom claims terbaru terbaca
      const token = await user.getIdTokenResult(true);
      const ok = isAdminLocal(user, token);
      statusEl.textContent = ok
        ? `‚úÖ Admin terdeteksi (UID: ${user.uid}${token?.claims?.isAdmin ? ", claim:isAdmin" : ""})`
        : `üö´ Kamu bukan admin (UID: ${user.uid}). Hubungi admin jika ini seharusnya admin.`;

      if (ok) {
        await loadUsers();
      } else {
        usersTable.style.display = "none";
      }
    } catch (e) {
      console.error(e);
      statusEl.textContent = "‚ö†Ô∏è Gagal membaca status admin: " + (e?.message || e);
      usersTable.style.display = "none";
    }
  });
</script>
</body>
</html>
