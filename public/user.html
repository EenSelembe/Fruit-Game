rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ======== Helper =========
    function signedIn() {
      return request.auth != null;
    }
    // Perkuat deteksi admin: UID tetap + dukung custom claim boolean/string
    function isAdmin() {
      return signedIn() && (
        request.auth.uid == "AxB4G2xwhiXdJnyDrzn82Xanc4x2" ||       // hardcoded UID admin
        request.auth.token.isAdmin == true ||                        // boolean
        request.auth.token.isAdmin == "true"                         // string fallback
      );
    }

    // ===== USERS =====
    match /users/{userId} {
      // Baca boleh untuk semua user login
      allow read: if signedIn();

      // TULIS boleh oleh pemilik dokumen ATAU admin (create/update/delete)
      allow write: if (signedIn() && request.auth.uid == userId) || isAdmin();
      // (Baris di atas mencakup create/update/delete, jadi kamu tidak perlu aturan terpisah.)
    }

    // ===== TRANSFERS =====
    match /transfers/{tid} {
      // Baca: pengirim/penerima atau admin
      allow read: if signedIn() && (
        resource.data.from == request.auth.token.email ||
        resource.data.to == request.auth.token.email ||
        isAdmin()
      );

      // Buat transfer (validasi + admin boleh atas nama)
      allow create: if signedIn()
        && request.resource.data.nominal is int
        && request.resource.data.to is string
        && request.resource.data.from is string
        && (
          request.resource.data.from == request.auth.token.email
          || isAdmin()
        );

      // Edit/hapus hanya admin
      allow update, delete: if isAdmin();
    }

    // ===== USERNAMES =====
    match /usernames/{username} {
      allow create: if signedIn()
                 && !exists(/databases/$(database)/documents/usernames/$(username));
      allow read: if signedIn();
      allow delete: if isAdmin();
    }

    // ===== GLOBAL CHAT =====
    match /globalChat/{messageId} {
      allow read: if signedIn();
      allow create: if signedIn()
                 && request.resource.data.text is string
                 && request.resource.data.text.size() > 0;
      allow update, delete: if isAdmin();
    }

    // ===== DIRECT MESSAGES =====
    match /dm/{userId}/messages/{msgId} {
      allow read: if signedIn()
               && (request.auth.uid == userId || request.auth.uid == resource.data.from);
      allow create: if signedIn()
                 && request.resource.data.text is string
                 && request.resource.data.text.size() > 0
                 && request.resource.data.from == request.auth.uid
                 && request.resource.data.to == userId;
      allow update, delete: if isAdmin();
    }

    // ===== NOTIFS =====
    match /notifs/{notifId} {
      allow read: if signedIn();
      allow create: if signedIn()
                 && request.resource.data.nickname is string
                 && request.resource.data.amount is int
                 && request.resource.data.createdAt != null;
      allow update: if false;
      allow delete: if signedIn(); // ubah ke isAdmin() kalau mau hanya admin
    }

    // ===== ROOMS (game & fitur lain) =====
    match /rooms/{roomId} {
      // baca/tulis room oleh user login (seperti sebelumnya), admin otomatis lolos
      allow read, write: if signedIn() || isAdmin();

      // Pemain (sinkron game)
      match /players/{uid} {
        allow read: if signedIn();
        // pemilik boleh tulis dokumennya, atau admin
        allow create, update, delete: if (signedIn() && request.auth.uid == uid) || isAdmin();
      }

      // Kursi (seat)
      match /seats/{seatNo} {
        allow read, write: if signedIn() || isAdmin();
      }

      // Peserta (presence per room)
      match /participants/{uid} {
        allow read, write: if (signedIn() && request.auth.uid == uid) || isAdmin();
      }

      // Chat room
      match /messages/{msgId} {
        allow read: if signedIn();
        allow create: if signedIn()
                   && request.resource.data.text is string
                   && request.resource.data.text.size() > 0;
        allow update, delete: if false;
        // admin override
        allow read, write: if isAdmin();
      }

      // Signaling WebRTC
      match /mesh/{pairId} {
        allow read, write: if signedIn() || isAdmin();
        match /ice_a/{cid} { allow read, write: if signedIn() || isAdmin(); }
        match /ice_b/{cid} { allow read, write: if signedIn() || isAdmin(); }
      }

      // Admin override di level room
      allow read, write: if isAdmin();
    }

    // ===== Presence global (online/offline) =====
    match /presence/{uid} {
      allow read: if signedIn();
      allow write: if (signedIn() && request.auth.uid == uid) || isAdmin();
    }
  }
}
