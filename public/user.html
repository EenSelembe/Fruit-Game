<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Daftar User</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; }
    h2 { margin: 12px 0 6px }
    #adminInfo { font-size: 13px; opacity:.85 }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #444; padding: 8px; text-align: center; }
    th { background: #333; }
    .btn { padding: 5px 10px; cursor: pointer; border: none; border-radius: 5px; }
    .btn-update { background: #4caf50; color: white; }
    .btn-update[disabled]{ opacity:.6; cursor:not-allowed }
    input, select { background:#222; border:1px solid #444; color:#fff; padding:3px; }
    .muted{opacity:.75}
  </style>
</head>
<body>
  <h2>📋 Daftar User</h2>
  <div id="status">🔒 Harus login sebagai admin dulu...</div>
  <div id="adminInfo" class="muted"></div>

  <table id="usersTable" style="display:none;">
    <thead>
      <tr>
        <th>UID</th>
        <th>Username</th>
        <th>Email</th>
        <th>Saldo</th>
        <th>Warna Teks</th>
        <th>Warna Border</th>
        <th>BG Color</th>
        <th>Border Gradient</th>
        <th>BG Gradient (Preset)</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, updateDoc } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB8g9X_En_sJnbdT_Rc1NK88dUdbg3y2nE",
      authDomain: "fruit-game-5e4a8.firebaseapp.com",
      projectId: "fruit-game-5e4a8",
      storageBucket: "fruit-game-5e4a8.appspot.com",
      messagingSenderId: "936228678997",
      appId: "1:936228678997:web:9dab2fa0d9a019161bd3dc",
      measurementId: "G-EPTSQQPM4D"
    };

    const ADMIN_UID = "AxB4G2xwhiXdJnyDrzn82Xanc4x2"; // UID admin tetap kamu

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Preset gradient list
    const presets = {
      "": "",
      "🌈 Rainbow": "linear-gradient(270deg, red, orange, yellow, green, blue, indigo, violet)",
      "💜 Pink-Purple": "linear-gradient(270deg, #ff00ff, #8000ff, #ff00ff)",
      "💙 Cyan-Blue": "linear-gradient(270deg, #00ffff, #0066ff, #00ffff)",
      "🔥 Gold-Red": "linear-gradient(270deg, gold, orange, red, gold)",
      "🌌 Galaxy": "linear-gradient(270deg, #00f, #8000ff, #ff00ff, #00f)",
      "💚 Green Neon": "linear-gradient(270deg, #00ff00, #00cc66, #00ff00)"
    };

    const $ = (s) => document.querySelector(s);

    function setStatus(text){ $("#status").textContent = text; }
    function setAdminInfo(user, token){
      $("#adminInfo").textContent = user
        ? `Login: ${user.email || "(tanpa email)"} | UID: ${user.uid} | isAdmin claim: ${token?.claims?.isAdmin ? "true" : "false"}`
        : "";
    }

    async function isAdminUser(user){
      if (!user) return false;
      // Cek claim + UID tetap
      const tokenResult = await user.getIdTokenResult(true); // force refresh
      const byClaim = !!tokenResult.claims.isAdmin;
      const byUid   = user.uid === ADMIN_UID;
      setAdminInfo(user, tokenResult);
      return byClaim || byUid;
    }

    async function loadUsers() {
      const tableBody = document.querySelector("#usersTable tbody");
      tableBody.innerHTML = "";
      // Ambil dari server; jika ingin paksa server, tambahkan cache: false (v9 tidak ada param). Ini tetap OK.
      const querySnapshot = await getDocs(collection(db, "users"));

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data() || {};
        const tr = document.createElement("tr");

        // Dropdown options
        let options = "";
        for (const [label, value] of Object.entries(presets)) {
          const selected = (data.bgGradient || "") === value ? "selected" : "";
          options += `<option value="${value}" ${selected}>${label}</option>`;
        }

        tr.innerHTML = `
          <td style="font-size:12px">${docSnap.id}</td>
          <td><input type="text" id="username-${docSnap.id}" value="${data.username || ''}" style="width:120px; color:${data.color || '#fff'};"></td>
          <td>${data.email || ''}</td>
          <td><input type="number" id="saldo-${docSnap.id}" value="${Number(data.saldo || 0)}" style="width:80px;"></td>
          <td><input type="color" id="color-${docSnap.id}" value="${data.color || '#ffffff'}"></td>
          <td><input type="color" id="border-${docSnap.id}" value="${data.borderColor || '#000000'}"></td>
          <td><input type="text"  id="bg-${docSnap.id}" value="${data.bgColor || ''}" placeholder="#000000"></td>
          <td><input type="text"  id="bordergrad-${docSnap.id}" value="${data.borderGradient || ''}" placeholder="linear-gradient(...)"></td>
          <td><select id="bggrad-${docSnap.id}" style="width:160px;">${options}</select></td>
          <td><button class="btn btn-update" id="btn-${docSnap.id}">Update</button></td>
        `;
        tableBody.appendChild(tr);

        // Pasang handler dengan try/catch, tampilkan error ke alert
        tr.querySelector(`#btn-${docSnap.id}`).addEventListener("click", async () => {
          const btn = tr.querySelector(`#btn-${docSnap.id}`);
          btn.disabled = true;
          btn.textContent = "Updating...";
          try{
            const newSaldo = Number(document.getElementById("saldo-" + docSnap.id).value);
            const newColor = document.getElementById("color-" + docSnap.id).value || null;
            const newBorder = document.getElementById("border-" + docSnap.id).value || null;
            const newBg = (document.getElementById("bg-" + docSnap.id).value || "").trim();
            const newBorderGrad = (document.getElementById("bordergrad-" + docSnap.id).value || "").trim();
            const newBgGrad = (document.getElementById("bggrad-" + docSnap.id).value || "").trim();
            const newUsername = (document.getElementById("username-" + docSnap.id).value || "").trim();

            const payload = {
              saldo: isFinite(newSaldo) ? newSaldo : 0,
              color: newColor,
              borderColor: newBorder,
              // simpan empty string sebagai null agar rapi (opsional)
              bgColor: newBg || null,
              borderGradient: newBorderGrad || null,
              bgGradient: newBgGrad || null,
              username: newUsername || null
            };

            await updateDoc(doc(db, "users", docSnap.id), payload);
            alert("✅ User " + docSnap.id + " berhasil diupdate!");
            await loadUsers(); // refresh
          }catch(err){
            console.error(err);
            alert("❌ Gagal update: " + (err && err.message ? err.message : err));
          }finally{
            btn.disabled = false;
            btn.textContent = "Update";
          }
        });
      });

      setStatus("✅ Login admin berhasil. Data user dimuat.");
      document.getElementById("usersTable").style.display = "table";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        setStatus("🔒 Harus login sebagai admin dulu...");
        setAdminInfo(null, null);
        const email = prompt("Masukkan email admin:");
        const password = prompt("Masukkan password admin:");
        if (email && password) {
          try{
            await signInWithEmailAndPassword(auth, email, password);
          }catch(err){
            alert("Login gagal: " + err.message);
          }
        }
        return;
      }

      try{
        const ok = await isAdminUser(user); // cek UID tetap + claim
        if (!ok) {
          setStatus("🚫 Kamu bukan admin!");
          return;
        }
        // admin → muat data
        await loadUsers();
      }catch(err){
        console.error(err);
        setStatus("❌ Error autentikasi admin: " + (err.message || err));
      }
    });
  </script>
</body>
</html>
